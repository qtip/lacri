{% extends 'lacri/main.html' %}

{% load staticfiles %}
{% load lacri_extras %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'lacri/css/main.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}lacri{% endblock %}

{% block js %}
  <script type="text/javascript" charset="utf-8">
    var allVisible = function(nodeList) {
      for (i = 0; i < nodeList.length; i++) {
        if (nodeList[i].style.visibility != "visible") {
          return false;
        }
      }
      return true;
    }

    var makePopForm = function(formQuery, inputsQuery) {
      var form = document.querySelector(formQuery);
      var inputs = document.querySelectorAll(inputsQuery);
      form.onsubmit = function() {
        if(!allVisible(inputs)) {
          Array.prototype.forEach.call(inputs, function(input){
            input.style.visibility = "visible";
            input.focus();
          });
          return false;
        }
        return true;
      }
    }

    makePopForm("#create_domain_form", "#id_domain-common_name")
    makePopForm("#create_client_form", "#id_client-common_name")
  </script>
{% endblock %}

{% block details %}
  <section class="authority light">
    <div class="container">
      <h2>{{ authority.common_name }}</h2>
    </div>
  </section>
  {% regroup children by usage as children_list %}
  {% for use in children_list %}
    <section class="roots light">
      <div class="container">
        <div class="row">
          <div class="seven columns">
            <h4>{{ use.grouper | usage_to_str }}s</h4>
          </div>
          <div class="five columns ">
            <form method="post" id="create_domain_form">
              {% csrf_token %}
              {{ domain_form.common_name }}
              <input type="submit" class="button-primary" value="New {{ use.grouper | usage_to_str }}" />
            </form>
          </div>
        </div>
        <div class="row">
          <table class="u-full-width">
            <thead>
              <tr>
                <th>Name</th>
              </tr>
            </thead>
            <tbody>
              {% for child in use.list %}
              <tr>
                <td><a href="{{ child | authority_detail_url }}">{{ child.common_name }}</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  {% endfor %}
  <section class="roots light">
    <div class="container">
      <div class="row">
        <div class="seven columns">
          <h4>Domains</h4>
        </div>
        <div class="five columns ">
          <form method="post" id="create_domain_form">
            {% csrf_token %}
            {{ domain_form.common_name }}
            <input type="submit" class="button-primary" value="New Domain" />
          </form>
        </div>
      </div>
      <div class="row">
        <table class="u-full-width">
          <thead>
            <tr>
              <th>Name</th>
            </tr>
          </thead>
          <tbody>
            {% for domain in domains %}
            <tr>
              {#<td><a href="{% url 'domain_detail' username=user.username slug=domain.parent.slug domain=domain.common_name%}">{{ domain.common_name }}</a></td>#}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="roots light">
    <div class="container">
      <div class="row">
        <div class="seven columns">
          <h4>Clients</h4>
        </div>
        <div class="five columns ">
          <form method="post" id="create_client_form">
            {% csrf_token %}
            {{ client_form.common_name }}
            <input type="submit" class="button-primary" value="New Client" />
          </form>
        </div>
      </div>
      <div class="row">
        <table class="u-full-width">
          <thead>
            <tr>
              <th>Name</th>
            </tr>
          </thead>
          <tbody>
            {% for client in clients %}
            <tr>
              <td><a href="{% url 'client_detail' username=user.username root_slug=client.parent.slug client=client.common_name%}">{{ client.common_name }}</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="trust arch light">
    <div class="container">
      <div class="row">
        <h4>Trust this root on arch linux</h4>
      </div>
      <div class="row">
        {#<pre><code>curl {{ view.request.scheme }}://{{ site.domain }}{% url 'root_cert_pem' username=username root_slug=root_slug %} &gt; /etc/ca-certificates/trust-source/anchors/{{ root.slug }}.crt#}
update-ca-trust</pre></code>
      </div>
    </div>
  </section>
  <section class="downloads light">
    <div class="container">
      <div class="row">
        <h4>Downloads</h4>
      </div>
      <div class="row">
        <table class="u-full-width">
          <thead>
            <tr>
              <th>File</th>
              <th>Description</th>
              <th>Fingerprint</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              {#<td><a href='{% url 'root_cert_pem' username=username root_slug=root_slug %}'>{{ root.slug }}.crt</a></td>#}
              <td>PEM formatted certificate</td>
              <td>{{ root.cert_fingerprint }}</td>
            </tr>
            <tr>
              {#<td><a href='{% url 'root_key_pem' username=username root_slug=root_slug %}'>{{ root.slug }}.key</a></td>#}
              <td>PEM formatted unencrypted key</td>
              <td>{{ root.key_fingerprint }}</td>
            </tr>
          </tbody>
        </table>
        <p></p>
      </div>
    </div>
  </section>
{% endblock %}
